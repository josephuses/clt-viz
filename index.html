<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLT: Variance & Spread</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f4f9; color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        h1 { margin: 0 0 10px 0; color: #2c3e50; }
        
        .container { max-width: 1000px; width: 100%; display: flex; flex-direction: column; gap: 20px; }
        
        /* Description Box */
        .info-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #27ae60; }
        
        /* Dashboard Layout */
        .dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        
        /* Controls */
        .controls { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: bold; text-transform: uppercase; color: #7f8c8d; margin-bottom: 5px; }
        input[type=range], select { width: 100%; }
        
        /* Stats Display */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.9em; border: 1px solid #dee2e6; }
        .stat-label { font-size: 0.8em; color: #666; display: block; }
        .stat-val { font-weight: bold; color: #2c3e50; font-size: 1.1em; }
        .theoretical { color: #e67e22; } /* Orange for theory */
        .observed { color: #2980b9; }    /* Blue for observed */

        /* Charts */
        .charts-area { display: flex; flex-direction: column; gap: 15px; }
        .chart-box { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .chart-title { position: absolute; top: 10px; left: 15px; font-weight: bold; font-size: 14px; color: #2c3e50; }
        
        /* SVG Styling */
        .bar-parent { fill: #bdc3c7; }
        .bar-sample { fill: #27ae60; }
        .axis text { fill: #7f8c8d; }
        .mean-line { stroke: #e74c3c; stroke-width: 2; stroke-dasharray: 4; }

    </style>
</head>
<body>

<div class="container">
   <h1>CLT: Variance Relationship</h1>
     <p>
            The Central Limit Theorem (CLT) states that if you take sufficiently large random samples from any population (regardless of its shape), the distribution of the sample means \( \bar{x} \) will be approximately Normal.
    </p>
    
    <div class="info-box">
        <p>The Central Limit Theorem predicts not just the shape, but the <strong>Variance</strong> of the sampling distribution.</p>
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div>
                <strong>Theory:</strong><br>
                \( \sigma^2_{\bar{x}} = \frac{\sigma^2}{n} \)
            </div>
            <div>
                <strong>Standard Deviation:</strong><br>
                \( SD(\bar{x}) = \frac{\sigma}{\sqrt{n}} \)
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="controls">
            <div class="control-group">
                <label>Parent Shape</label>
                <select id="distType">
                    <option value="normal">Normal</option>
                    <option value="uniform">Uniform (Flat)</option>
                    <option value="bimodal">Bimodal (Two Peaks)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Population Spread (\( \sigma \))</label>
                <input type="range" id="sigmaSlider" min="5" max="25" step="1" value="15">
                <div style="display:flex; justify-content:space-between; font-size:0.85em;">
                    <span>Low Var</span>
                    <span id="sigmaDisplay" style="font-weight:bold; color:#e67e22;">15</span>
                    <span>High Var</span>
                </div>
            </div>

            <div class="control-group">
                <label>Sample Size (n)</label>
                <input type="range" id="nSlider" min="2" max="250" value="10">
                <span id="nDisplay" style="text-align:right; font-weight:bold;">10</span>
            </div>

            <div class="control-group">
                <label>Samples (k)</label>
                <input type="range" id="kSlider" min="100" max="5000" step="100" value="2000">
                <span id="kDisplay" style="text-align:right; font-weight:bold;">2000</span>
            </div>

            <hr style="width:100%; border:0; border-top:1px solid #eee;">
            
            <label>Real-time Statistics</label>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Pop Variance (\( \sigma^2 \))</span>
                    <span id="popVarVal" class="stat-val observed">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pop SD (\( \sigma \))</span>
                    <span id="popSDVal" class="stat-val observed">0</span>
                </div>
                
                <div class="stat-item" style="grid-column: span 2; background: #e8f5e9; border-color: #c3e6cb;">
                    <span class="stat-label">Theoretical \( Var(\bar{x}) = \sigma^2 / n \)</span>
                    <span id="theoVarVal" class="stat-val theoretical">0</span>
                </div>
                <div class="stat-item" style="grid-column: span 2; background: #e8f5e9; border-color: #c3e6cb;">
                    <span class="stat-label">Observed \( Var(\bar{x}) \)</span>
                    <span id="sampleVarVal" class="stat-val observed">0</span>
                </div>
            </div>

            <button onclick="runSimulation()" style="background:#27ae60; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:bold; margin-top:10px;">Run Simulation</button>
        </div>

        <div class="charts-area">
            <div class="chart-box">
                <div class="chart-title">Parent Population (x)</div>
                <div id="parentChart"></div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Sampling Distribution (\( \bar{x} \))</div>
                <div id="sampleChart"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Setup ---
    const margin = {top: 30, right: 20, bottom: 30, left: 40};
    const width = 600 - margin.left - margin.right;
    const height = 220 - margin.top - margin.bottom;

    function createSvg(id) {
        return d3.select(id).append("svg")
            .attr("viewBox", `0 0 600 220`)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
    }

    const svgParent = createSvg("#parentChart");
    const svgSample = createSvg("#sampleChart");

    // X Scale (Fixed 0-100)
    const x = d3.scaleLinear().domain([0, 100]).range([0, width]);
    
    // Axes
    svgParent.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
    svgSample.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));

    // --- Data Generators ---
    function generateParent(type, nPoints, targetSigma) {
        let data = [];
        const mean = 50; 
        
        // Generators based on requested Sigma
        // Note: We approximate parameters to achieve targetSigma
        
        if (type === 'normal') {
            const gen = d3.randomNormal(mean, targetSigma);
            data = Array.from({length: nPoints}, gen);
        } 
        else if (type === 'uniform') {
            // For Uniform(a,b), Variance = (b-a)^2 / 12
            // Sigma = (b-a) / sqrt(12)  => Width = Sigma * 3.46
            const width = targetSigma * Math.sqrt(12);
            const min = mean - width/2;
            const max = mean + width/2;
            const gen = d3.randomUniform(min, max);
            data = Array.from({length: nPoints}, gen);
        }
        else if (type === 'bimodal') {
            // Mix two normals. To increase total variance, we move peaks apart.
            // Let's keep peak width constant-ish and move them based on Sigma.
            // Simplified: Peak1 at 50-offset, Peak2 at 50+offset
            const offset = targetSigma * 0.9; // heuristic scaling
            const gen1 = d3.randomNormal(mean - offset, 5);
            const gen2 = d3.randomNormal(mean + offset, 5);
            for(let i=0; i<nPoints; i++) {
                data.push(Math.random() < 0.5 ? gen1() : gen2());
            }
        }

        // Clamp to 0-100 visual range
        return data.map(d => Math.max(0, Math.min(100, d)));
    }

    // --- Stats Calculator ---
    function getStats(data) {
        const mean = d3.mean(data);
        const variance = d3.variance(data);
        const sd = d3.deviation(data);
        return { mean, variance, sd };
    }

    // --- Drawing ---
    function drawHist(svg, data, color) {
        // Binning
        const bins = d3.bin().domain(x.domain()).thresholds(x.ticks(50))(data);
        
        // Y Scale
        const y = d3.scaleLinear()
            .domain([0, d3.max(bins, d => d.length)])
            .range([height, 0]);

        // Bars
        const bars = svg.selectAll("rect").data(bins);
        
        bars.join(
            enter => enter.append("rect")
                .attr("x", d => x(d.x0) + 1)
                .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr("y", height)
                .attr("height", 0)
                .attr("fill", color)
                .call(enter => enter.transition().duration(500)
                    .attr("y", d => y(d.length))
                    .attr("height", d => height - y(d.length))
                ),
            update => update.transition().duration(500)
                .attr("y", d => y(d.length))
                .attr("height", d => height - y(d.length))
                .attr("fill", color), // Ensure color stays
            exit => exit.remove()
        );
    }

    // --- Main Simulation ---
    function runSimulation() {
        // 1. Get Inputs
        const type = document.getElementById('distType').value;
        const targetSigma = parseFloat(document.getElementById('sigmaSlider').value);
        const n = parseInt(document.getElementById('nSlider').value);
        const k = parseInt(document.getElementById('kSlider').value);

        // Update Labels
        document.getElementById('sigmaDisplay').innerText = targetSigma;
        document.getElementById('nDisplay').innerText = n;
        document.getElementById('kDisplay').innerText = k;

        // 2. Generate Parent Data (Large population proxy)
        const popSize = 5000;
        const parentData = generateParent(type, popSize, targetSigma);
        
        // 3. Generate Samples
        let sampleMeans = [];
        for(let i=0; i<k; i++) {
            // Simple random sample from the parentData array
            let sum = 0;
            for(let j=0; j<n; j++) {
                sum += parentData[Math.floor(Math.random() * popSize)];
            }
            sampleMeans.push(sum/n);
        }

        // 4. Calculate Statistics
        const popStats = getStats(parentData);
        const sampleStats = getStats(sampleMeans);
        
        const theoreticalSampleVar = popStats.variance / n;

        // 5. Update UI Stats
        document.getElementById('popVarVal').innerText = popStats.variance.toFixed(2);
        document.getElementById('popSDVal').innerText = popStats.sd.toFixed(2);
        
        document.getElementById('theoVarVal').innerText = theoreticalSampleVar.toFixed(2);
        document.getElementById('sampleVarVal').innerText = sampleStats.variance.toFixed(2);

        // 6. Draw Charts
        drawHist(svgParent, parentData, "#bdc3c7");
        drawHist(svgSample, sampleMeans, "#27ae60");
    }

    // --- Event Listeners ---
    document.getElementById('sigmaSlider').addEventListener('input', runSimulation);
    document.getElementById('nSlider').addEventListener('input', runSimulation);
    document.getElementById('kSlider').addEventListener('change', runSimulation); // 'change' for k to improve perf
    document.getElementById('distType').addEventListener('change', runSimulation);

    // Init
    runSimulation();

</script>

</body>
</html>
